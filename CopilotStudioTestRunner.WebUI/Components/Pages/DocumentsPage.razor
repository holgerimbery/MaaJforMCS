@page "/documents"
@layout MainLayout
@attribute [Authorize]
@using CopilotStudioTestRunner.Data
@using CopilotStudioTestRunner.Domain.Entities
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms

<div style="max-width: 1200px;">
    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
        <label class="btn btn-primary" for="fileInputElement" style="pointer-events: @(isUploading ? "none" : "auto"); opacity: @(isUploading ? "0.6" : "1");">
            <i class="bi bi-cloud-arrow-up"></i> Upload Document
        </label>
        <button class="btn btn-outline-secondary" @onclick="Refresh" disabled="@isUploading">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <InputFile id="fileInputElement" OnChange="OnFileSelected" style="display: none;" accept=".pdf,.txt,.docx,.doc" />
    </div>

    @if (!string.IsNullOrEmpty(successMsg))
    {
        <div class="alert alert-success alert-dismissible fade show slide-in-left" role="alert" style="margin-bottom: 20px;">
            <i class="bi bi-check-circle"></i> @successMsg
            <button type="button" class="btn-close" @onclick="@((e) => { successMsg = null; })"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMsg))
    {
        <div class="alert alert-danger alert-dismissible fade show slide-in-left" role="alert" style="margin-bottom: 20px;">
            <i class="bi bi-exclamation-circle"></i> @errorMsg
            <button type="button" class="btn-close" @onclick="@((e) => { errorMsg = null; })"></button>
        </div>
    }

    @if (isUploading)
    {
        <div class="card fade-in" style="text-align: center;">
            <div class="card-body">
                <div class="spinner-border text-primary mb-3"></div>
                <p style="color: var(--text-secondary);">Uploading document...</p>
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: 100%; animation: pulse 1s infinite;"></div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div style="text-align: center; padding: 40px;">
            <div class="spinner-border text-primary"></div>
            <p style="margin-top: 15px; color: var(--text-secondary);">Loading documents...</p>
        </div>
    }
    else if (documents == null || documents.Count == 0)
    {
        <div class="card fade-in" style="text-align: center; padding: 60px 20px;">
            <i class="bi bi-file-earmark" style="font-size: 3em; color: var(--border);"></i>
            <p style="margin-top: 15px; color: var(--text-tertiary);">No documents uploaded</p>
            <small style="color: var(--text-tertiary);">Click "Upload Document" above to add documents for testing</small>
        </div>
    }
    else
    {
        <div class="card fade-in" style="overflow: hidden;">
            <table class="table" style="margin-bottom: 0;">
                <thead>
                    <tr>
                        <th style="text-align: left;">File Name</th>
                        <th style="text-align: left;">Type</th>
                        <th style="text-align: center;">Size</th>
                        <th style="text-align: center;">Chunks</th>
                        <th style="text-align: left;">Uploaded</th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var doc in documents)
                    {
                        <tr>
                            <td>
                                <i class="bi bi-file-earmark-text" style="color: var(--primary); margin-right: 8px;"></i> <strong>@doc.Name</strong>
                            </td>
                            <td>
                                <span class="badge badge-secondary" style="background-color: rgba(139, 92, 246, 0.15); color: var(--secondary); padding: 6px 10px;">
                                    @doc.DocumentType.ToUpper()
                                </span>
                            </td>
                            <td style="text-align: center;">
                                @FormatFileSize(doc.FileSizeBytes)
                            </td>
                            <td style="text-align: center;">
                                @(doc.Chunks?.Count ?? 0)
                            </td>
                            <td style="font-size: 0.9em;">
                                @doc.UploadedAt.ToString("MMM dd, yyyy HH:mm")
                            </td>
                            <td style="text-align: center;">
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteDocument(doc.Id)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="alert alert-info fade-in" style="margin-top: 20px; animation-delay: 0.5s;">
            <i class="bi bi-info-circle" style="margin-right: 8px;"></i> <strong>Total:</strong> @documents.Count document(s) | 
            <strong>Total Size:</strong> @FormatFileSize(documents.Sum(d => d.FileSizeBytes)) | 
            <strong>Total Chunks:</strong> @documents.Sum(d => d.Chunks?.Count ?? 0)
        </div>
    }
</div>

@code {
    [Inject]
    private TestRunnerDbContext? DbContext { get; set; }

    private List<Document>? documents;
    private bool isLoading = true;
    private bool isUploading = false;
    private string successMsg = "";
    private string errorMsg = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        try
        {
            if (DbContext == null) return;

            isLoading = true;
            documents = await DbContext.Documents
                .Include(d => d.Chunks)
                .OrderByDescending(d => d.UploadedAt)
                .ToListAsync();
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMsg = $"Error loading documents: {ex.Message}";
            isLoading = false;
        }
    }


    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            isUploading = true;
            successMsg = "";
            errorMsg = "";

            if (DbContext == null)
            {
                errorMsg = "Database context not available";
                isUploading = false;
                return;
            }

            var file = e.File;
            if (file == null)
            {
                errorMsg = "No file selected";
                isUploading = false;
                return;
            }

            // Validate file size (max 50MB)
            const long maxFileSize = 50 * 1024 * 1024;
            if (file.Size > maxFileSize)
            {
                errorMsg = $"File is too large. Maximum size is 50MB. Your file is {FormatFileSize(file.Size)}";
                isUploading = false;
                return;
            }

            // Read file content
            using var stream = file.OpenReadStream(maxAllowedSize: maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var fileBytes = memoryStream.ToArray();
            var fileContent = System.Text.Encoding.UTF8.GetString(fileBytes);

            if (string.IsNullOrWhiteSpace(fileContent))
            {
                errorMsg = "File appears to be empty or not readable as text";
                isUploading = false;
                return;
            }

            // Create document record
            var contentHash = System.Security.Cryptography.SHA256.HashData(fileBytes);
            var hashString = System.Convert.ToHexString(contentHash);
            
            var doc = new Document
            {
                Id = Guid.NewGuid(),
                Name = file.Name,
                DocumentType = GetDocumentType(file.Name),
                FileSizeBytes = file.Size,
                ContentHash = hashString,
                UploadedAt = DateTime.UtcNow,
                Chunks = new List<Chunk>()
            };

            // Create chunks (split content into ~500 character chunks for better processing)
            var chunkSize = 500;
            var chunkOverlap = 50; // Overlap for context
            var chunks = new List<string>();
            
            for (int i = 0; i < fileContent.Length; i += chunkSize - chunkOverlap)
            {
                var endIndex = Math.Min(i + chunkSize, fileContent.Length);
                var chunkText = fileContent.Substring(i, endIndex - i);
                if (!string.IsNullOrWhiteSpace(chunkText))
                {
                    chunks.Add(chunkText);
                }
            }

            // If no chunks were created (empty file after processing), create single chunk
            if (chunks.Count == 0)
            {
                chunks.Add(fileContent);
            }

            // Create chunk entities
            for (int i = 0; i < chunks.Count; i++)
            {
                doc.Chunks!.Add(new Chunk
                {
                    Id = Guid.NewGuid(),
                    DocumentId = doc.Id,
                    ChunkIndex = i,
                    Text = chunks[i],
                    TokenCount = chunks[i].Split(" ").Length // Approximate token count
                });
            }

            // Save to database
            DbContext.Documents.Add(doc);
            await DbContext.SaveChangesAsync();

            successMsg = $"âœ“ Document '{file.Name}' uploaded successfully with {chunks.Count} chunks";
            await LoadDocuments();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error uploading document: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private string GetDocumentType(string fileName)
    {
        var extension = System.IO.Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "PDF",
            ".docx" => "DOCX",
            ".doc" => "DOC",
            ".txt" => "TXT",
            _ => "OTHER"
        };
    }

    private async Task Refresh()
    {
        await LoadDocuments();
    }

    private async Task DeleteDocument(Guid documentId)
    {
        try
        {
            if (DbContext == null) return;

            var doc = await DbContext.Documents.FindAsync(documentId);
            if (doc == null) return;

            DbContext.Documents.Remove(doc);
            await DbContext.SaveChangesAsync();

            successMsg = "Document deleted";
            await LoadDocuments();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error deleting document: {ex.Message}";
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
