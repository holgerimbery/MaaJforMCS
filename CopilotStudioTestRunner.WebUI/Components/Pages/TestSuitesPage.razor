@page "/test-suites"
@layout MainLayout
@attribute [Authorize]
@using CopilotStudioTestRunner.Data
@using CopilotStudioTestRunner.Domain.Entities
@using CopilotStudioTestRunner.Domain.Configuration
@using CopilotStudioTestRunner.Core.DirectLine
@using CopilotStudioTestRunner.Core.Evaluation
@using CopilotStudioTestRunner.Core.Execution
@using CopilotStudioTestRunner.Core.Services
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using System.IO
@using Microsoft.AspNetCore.Components.Forms

@inject IQuestionGenerationService QuestionGenerationService
@inject ITestExecutionService ExecutionService
@inject IJudgeService JudgeService
@inject IJSRuntime JS
@inject IAgentConfigurationService AgentConfigService

<div style="max-width: 1200px;">
    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
        <button class="btn btn-primary" @onclick="OnShowNewSuiteForm">
            <i class="bi bi-plus-circle"></i> Create New Suite
        </button>
        <button class="btn btn-outline-secondary" @onclick="Refresh">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>

    @if (!string.IsNullOrEmpty(successMsg))
    {
        <div class="alert alert-success alert-dismissible fade show slide-in-left" role="alert">
            <i class="bi bi-check-circle"></i> @successMsg
            <button type="button" class="btn-close" @onclick="@((e) => { successMsg = null; })"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMsg))
    {
        <div class="alert alert-danger alert-dismissible fade show slide-in-left" role="alert">
            <i class="bi bi-exclamation-circle"></i> @errorMsg
            <button type="button" class="btn-close" @onclick="@((e) => { errorMsg = null; })"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(runStatusMsg))
    {
        <div class="alert alert-info slide-in-left" role="alert">
            <i class="bi bi-hourglass-split"></i> @runStatusMsg
        </div>
    }

    @if (showAgentSelectionModal)
    {
        <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;" @onclick="() => showAgentSelectionModal = false">
            <div class="modal-content" style="background: #ffffff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 500px; width: 100%; position: relative;" @onclick:stopPropagation="true">
                <!-- Modal Header -->
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 24px; border-bottom: 1px solid #e8eaed; border-radius: 12px 12px 0 0;">
                    <h3 style="margin: 0; color: #1f1f23;">
                        <i class="bi bi-robot" style="color: #0066cc; margin-right: 8px;"></i>Select Agent
                    </h3>
                    <button type="button" class="btn-close" @onclick="() => showAgentSelectionModal = false" style="margin: 0;"></button>
                </div>

                <!-- Modal Body -->
                <div style="padding: 24px;">
                    <p style="color: #5f5f5f; margin-bottom: 20px;">Select which test agent to use for running this suite:</p>
                    
                    @if (availableAgents == null || availableAgents.Count == 0)
                    {
                        <div class="alert alert-info" style="margin-bottom: 20px;">
                            <i class="bi bi-info-circle"></i> No agents available. <a href="/agents" style="color: #0066cc; font-weight: 500;">Create an agent first</a>.
                        </div>
                    }
                    else
                    {
                        <div style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                            @foreach (var agent in availableAgents)
                            {
                                <div style="display: flex; align-items: center; padding: 12px; border: 1px solid #e8eaed; border-radius: 8px; cursor: pointer; transition: all 0.2s; border-color: @(selectedAgentId == agent.Id ? "#0066cc" : "#e8eaed"); background-color: @(selectedAgentId == agent.Id ? "#f0f6ff" : "#ffffff");" 
                                     class="@(selectedAgentId == agent.Id ? "agent-selected" : "")"
                                     @onclick="() => selectedAgentId = agent.Id">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #1f1f23; margin-bottom: 4px;">@agent.Name</div>
                                        <small style="color: #5f5f5f; display: block;">
                                            <i class="bi bi-gear" style="margin-right: 4px;"></i>
                                            @(agent.Environment ?? "production")
                                        </small>
                                    </div>
                                    <div style="flex-shrink: 0; margin-left: 12px;">
                                        @if (selectedAgentId == agent.Id)
                                        {
                                            <i class="bi bi-check2-circle" style="color: #0066cc; font-size: 20px;"></i>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Modal Footer -->
                <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; border-top: 1px solid #e8eaed; background-color: #f5f6f8; border-radius: 0 0 12px 12px;">
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => showAgentSelectionModal = false">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmAgentSelection" disabled="@(selectedAgentId == null || availableAgents == null || availableAgents.Count == 0)">
                        <i class="bi bi-play-circle"></i> Run Suite
                    </button>
                </div>
            </div>
        </div>
    }

    @if (showEditModal)
    {
        <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;" @onclick="CloseEditModal">
            <div class="modal-content" style="background: #ffffff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 900px; width: 100%; max-height: 85vh; overflow-y: auto; position: relative;" @onclick:stopPropagation="true">
                <!-- Modal Header -->
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 24px; border-bottom: 1px solid #e8eaed; position: sticky; top: 0; background: #ffffff; border-radius: 12px 12px 0 0;">
                    <h3 style="margin: 0; color: #1f1f23;">
                        <i class="bi bi-pencil" style="color: #0066cc; margin-right: 8px;"></i>Edit Test Suite: @editingSuite?.Name
                    </h3>
                    <button type="button" class="btn-close" @onclick="CloseEditModal" style="margin: 0;"></button>
                </div>

                <!-- Modal Body -->
                <div style="padding: 24px;">
                    <div class="mb-4">
                        <label class="form-label">Suite Name</label>
                        <input type="text" class="form-control" @bind="editingSuiteName" />
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" @bind="editingSuiteDescription" rows="3"></textarea>
                    </div>

                    <hr style="border: none; border-top: 1px solid #e8eaed; margin: 24px 0;" />

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0; color: #1f1f23;"><i class="bi bi-list-check" style="color: #0066cc; margin-right: 8px;"></i>Test Cases (@editingSuite?.TestCases?.Count ?? 0)</h4>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-sm btn-primary" @onclick="ShowAddTestCaseForm">
                                <i class="bi bi-plus-circle"></i> Add
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" @onclick="DownloadTemplateCSV">
                                <i class="bi bi-download"></i> Template
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" @onclick="ExportTestCasesCSV">
                                <i class="bi bi-box-arrow-down"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning" @onclick="ShowImportForm">
                                <i class="bi bi-box-arrow-up"></i> Import
                            </button>
                        </div>
                    </div>

                    <div style="border: 1px solid #e8eaed; border-radius: 8px; padding: 16px; background-color: #f5f6f8; margin-bottom: 20px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                            <strong style="color: #0066cc; font-size: 14px;">AI Questions</strong>
                            <input type="number" class="form-control" style="width: 120px; flex-shrink: 0;" min="1" max="50" @bind="aiQuestionCount" />
                            <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => GenerateAiQuestions(true)" disabled="@isGeneratingQuestions">
                                <i class="bi bi-arrow-repeat"></i> Replace All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => GenerateAiQuestions(false)" disabled="@isGeneratingQuestions">
                                <i class="bi bi-plus"></i> Add
                            </button>
                            @if (isGeneratingQuestions)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span style="font-size: 12px; color: #5f5f5f;">Generating...</span>
                            }
                        </div>
                        <small style="color: #5f5f5f; display: block; margin-top: 8px;">Uses Azure OpenAI settings. Upload documents before generating for best results.</small>
                    </div>

                @if (showAddTestCase)
                {
                    <div class="alert alert-info" style="margin-bottom: 20px;">
                        <h6><i class="bi bi-plus-circle"></i> Add New Test Case</h6>
                        <div class="mb-2">
                            <label class="form-label">Test Name</label>
                            <input type="text" class="form-control" @bind="newTestCaseName" placeholder="E.g., Test greeting functionality" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">User Input (Question)</label>
                            <input type="text" class="form-control" @bind="newTestCaseQuestion" placeholder="What question should be asked?" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Expected Answer (optional)</label>
                            <textarea class="form-control" @bind="newTestCaseExpectedAnswer" rows="2" placeholder="What response do you expect?"></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Acceptance Criteria</label>
                            <textarea class="form-control" @bind="newTestCaseAcceptance" rows="2" placeholder="What makes this test pass?"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-sm btn-success" @onclick="AddTestCase" disabled="@string.IsNullOrWhiteSpace(newTestCaseQuestion)">
                                <i class="bi bi-check"></i> Add
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => showAddTestCase = false">
                                Cancel
                            </button>
                        </div>
                    </div>
                }

                @if (showEditTestCase)
                {
                    <div class="alert alert-warning" style="margin-bottom: 20px;">
                        <h6><i class="bi bi-pencil"></i> Edit Test Case</h6>
                        <div class="mb-2">
                            <label class="form-label">Test Name</label>
                            <input type="text" class="form-control" @bind="editingTestCaseName" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">User Input (Question)</label>
                            <input type="text" class="form-control" @bind="editingTestCaseQuestion" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Expected Answer (optional)</label>
                            <textarea class="form-control" @bind="editingTestCaseExpectedAnswer" rows="2"></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Acceptance Criteria</label>
                            <textarea class="form-control" @bind="editingTestCaseAcceptance" rows="2"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-sm btn-success" @onclick="SaveTestCaseChanges" disabled="@string.IsNullOrWhiteSpace(editingTestCaseQuestion)">
                                <i class="bi bi-check"></i> Save
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => { showEditTestCase = false; editingTestCase = null; }">
                                Cancel
                            </button>
                        </div>
                    </div>
                }

                @if (showImportForm)
                {
                    <div class="alert alert-warning" style="margin-bottom: 20px;">
                        <h6><i class="bi bi-box-arrow-up"></i> Import Test Cases from CSV</h6>
                        <p style="font-size: 0.9em; margin: 10px 0;">Upload a CSV file with 'question' and 'expectedResponse' columns.</p>
                        <div class="mb-2">
                            <InputFile accept=".csv" OnChange="HandleFileSelected" />
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-sm btn-success" @onclick="ImportTestCasesFromCSV" disabled="@(!hasFileSelected)">
                                <i class="bi bi-check"></i> Import
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => { showImportForm = false; hasFileSelected = false; importMsg = string.Empty; }">
                                Cancel
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(importMsg))
                        {
                            <small style="display: block; margin-top: 10px; color: #666;">@importMsg</small>
                        }
                    </div>
                }

                @if (editingSuite?.TestCases != null && editingSuite.TestCases.Count > 0)
                {
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e8eaed; border-radius: 8px; padding: 16px; background-color: #f5f6f8;">
                        @foreach (var testCase in editingSuite.TestCases)
                        {
                            <div class="test-case-card">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                                    <div style="flex: 1;">
                                        <strong style="color: #1f1f23; font-size: 15px;">@testCase.Name</strong>
                                        <p style="margin: 6px 0; font-size: 13px; color: #5f5f5f;"><i class="bi bi-chat-left-text" style="color: #0066cc; margin-right: 4px;"></i> @(testCase.UserInput?.FirstOrDefault() ?? testCase.Description ?? "No question")</p>
                                        @if (!string.IsNullOrWhiteSpace(testCase.ReferenceAnswer))
                                        {
                                            <small style="display: block; color: #0066cc; margin-top: 6px; font-weight: 500;"><i class="bi bi-check2-circle"></i> Expected: @testCase.ReferenceAnswer</small>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(testCase.AcceptanceCriteria))
                                        {
                                            <small style="color: #5f5f5f; display: block; margin-top: 4px;"><i class="bi bi-check-circle"></i> @testCase.AcceptanceCriteria</small>
                                        }
                                    </div>
                                    <div style="display: flex; gap: 6px; margin-left: 12px; flex-shrink: 0;">
                                        <button type="button" class="btn btn-sm btn-outline-info" @onclick="() => GenerateAdditionalQuestionsForTestCase(testCase.Id)" title="Generate 10 semantic variations" disabled="@isGeneratingQuestions">
                                            <i class="bi bi-stars"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => EditTestCase(testCase.Id)" title="Edit this test case">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTestCase(testCase.Id)" title="Delete this test case">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning" style="margin-bottom: 20px;">
                        <i class="bi bi-exclamation-triangle"></i> No test cases yet. Add test cases to enable testing.
                    </div>
                }
                </div>

                <!-- Modal Footer -->
                <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; border-top: 1px solid #e8eaed; background-color: #f5f6f8; border-radius: 0 0 12px 12px; position: sticky; bottom: 0;">
                    <button type="button" class="btn btn-outline-secondary" @onclick="CloseEditModal">
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="SaveSuiteChanges">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    }

    @if (showNewSuiteForm)
    {
        <div style="background: #ffffff; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e8eaed; border-left: 4px solid #0066cc;">
            <h4 style="margin-bottom: 20px; color: #0066cc;"><i class="bi bi-plus-circle" style="margin-right: 8px;"></i>Create New Test Suite</h4>
            
            <div style="margin-bottom: 20px;">
                <label class="form-label" style="font-weight: 500;">Suite Name <span style="color: red;">*</span></label>
                <input type="text" class="form-control" @bind="newSuiteName" placeholder="E.g., Greeting Test Suite" />
            </div>

            <div class="mb-4">
                <label class="form-label" style="font-weight: 500;">Description</label>
                <textarea class="form-control" @bind="newSuiteDescription" placeholder="Describe what this test suite tests" rows="2"></textarea>
            </div>

            <hr style="margin: 20px 0;" />

            <div class="mb-4">
                <h6 style="color: #0066cc; margin-bottom: 15px;"><i class="bi bi-file-earmark"></i> Related Documents</h6>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Select documents to link with test cases (optional)</p>
                
                @if (availableDocuments == null || availableDocuments.Count == 0)
                {
                    <div class="alert alert-info" style="margin-bottom: 15px;">
                        <i class="bi bi-info-circle"></i> No documents available yet. <a href="/wizard" style="color: #0066cc;">Go to Setup Wizard</a> to upload documents.
                    </div>
                }
                else
                {
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto; margin-bottom: 10px;">
                        @foreach (var doc in availableDocuments)
                        {
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="doc_@doc.Id" 
                                       checked="@newSuiteSelectedDocuments.Contains(doc.Id)" 
                                       @onchange="e => OnDocumentSelectionChanged(doc.Id, e)" />
                                <label class="form-check-label" for="doc_@doc.Id">
                                    <strong>@doc.Name</strong> <span style="color: #999; font-size: 0.9em;">(@doc.Chunks.Count chunks)</span>
                                </label>
                            </div>
                        }
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="SelectAllNewSuiteDocuments">
                            <i class="bi bi-check-all"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ClearNewSuiteDocumentSelection">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                    </div>
                }
            </div>

            <hr style="margin: 20px 0;" />

            <div class="mb-4" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #0066cc;">
                <h6 style="color: #0066cc; margin-bottom: 15px;"><i class="bi bi-robot"></i> Agent Selection</h6>
                
                @if (createSuiteAgents == null || createSuiteAgents.Count == 0)
                {
                    <div class="alert alert-warning" style="margin-bottom: 15px;">
                        <i class="bi bi-exclamation-triangle"></i> No agents available. <a href="/agents" style="color: #0066cc;">Create an agent first</a>.
                    </div>
                }
                else
                {
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Select an agent to generate and run questions with this suite</p>
                    <select class="form-select" @bind="newSuiteSelectedAgentId">
                        <option value="">-- Select an agent --</option>
                        @foreach (var agent in createSuiteAgents)
                        {
                            <option value="@agent.Id">@agent.Name (@agent.Environment)</option>
                        }
                    </select>
                }
            </div>

            <div class="mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="generateQuestionsCheck" @bind="newSuiteGenerateQuestions" disabled="@(string.IsNullOrEmpty(newSuiteSelectedAgentId))" />
                    <label class="form-check-label" for="generateQuestionsCheck">
                        Generate test questions from selected documents
                    </label>
                    <small class="form-text text-muted d-block mt-1">
                        Requires documents to be selected and an agent to be configured
                    </small>
                </div>
            </div>

            @if (newSuiteGenerateQuestions && newSuiteSelectedDocuments.Count > 0)
            {
                <div class="mb-4" style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <label class="form-label" style="font-weight: 500;">Number of Questions to Generate</label>
                    <input type="number" class="form-control" @bind="newSuiteQuestionCount" min="5" max="50" />
                    <small class="form-text text-muted">Questions will be auto-generated from your selected documents</small>
                </div>
            }

            <div style="display: flex; gap: 12px;">
                <button type="button" class="btn btn-primary" @onclick="CreateNewSuiteWithOptions" disabled="@string.IsNullOrWhiteSpace(newSuiteName)">
                    <i class="bi bi-plus"></i> Create Suite
                </button>
                <button type="button" class="btn btn-outline-secondary" @onclick="() => { showNewSuiteForm = false; ResetNewSuiteForm(); }">
                    Cancel
                </button>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div style="text-align: center; padding: 60px 40px;">
            <div class="spinner-border" style="color: #0066cc; width: 3rem; height: 3rem;"></div>
            <p style="margin-top: 16px; color: #5f5f5f; font-size: 15px;">Loading test suites...</p>
        </div>
    }
    else if (testSuites == null || testSuites.Count == 0)
    {
        <div style="background: #ffffff; padding: 60px 40px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; border: 1px solid #e8eaed;">
            <i class="bi bi-inbox" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;"></i>
            <p style="margin: 0 0 8px 0; color: #1f1f23; font-size: 16px; font-weight: 500;">No test suites yet</p>
            <small style="color: #5f5f5f;">Click "Create New Suite" above to get started</small>
        </div>
    }
    else
    {
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            @foreach (var suite in testSuites)
            {
                <div style="background: #ffffff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e8eaed; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" class="suite-card">
                    <div style="padding: 20px;">
                        <h5 style="color: #0066cc; margin: 0 0 12px 0; font-weight: 600;"><i class="bi bi-list-check" style="margin-right: 8px;"></i>@suite.Name</h5>
                        <p style="color: #5f5f5f; font-size: 13px; margin: 0 0 16px 0; line-height: 1.5;">
                            @(string.IsNullOrWhiteSpace(suite.Description) ? "No description" : suite.Description)
                        </p>
                        <div style="font-size: 12px; color: #5f5f5f; margin-bottom: 16px; line-height: 1.6;">
                            <div><i class="bi bi-calendar2" style="margin-right: 6px;"></i>Created: @suite.CreatedAt.ToString("MMM dd, yyyy")</div>
                            <div><i class="bi bi-test" style="margin-right: 6px;"></i>Test Cases: <strong>@(suite.TestCases?.Count ?? 0)</strong></div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-primary" @onclick="() => RunSuite(suite.Id)" disabled="@isRunningSuite">
                                @if (isRunningSuite && runningSuiteId == suite.Id)
                                {
                                    <span>
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="margin-right: 4px;"></span>Running...
                                    </span>
                                }
                                else
                                {
                                    <span>
                                        <i class="bi bi-play-circle"></i> Run
                                    </span>
                                }
                            </button>
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => EditSuite(suite.Id)">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteSuite(suite.Id)">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
.suite-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
}
</style>

@code {
    [Inject]
    public TestRunnerDbContext? DbContext { get; set; }

    private List<TestSuite>? testSuites;
    private bool isLoading = true;
    private bool showNewSuiteForm = false;
    private string newSuiteName = "";
    private string newSuiteDescription = "";
    private string successMsg = "";
    private string errorMsg = "";
    private string runStatusMsg = "";
    private bool isRunningSuite = false;
    private Guid? runningSuiteId;

    // New Suite Form
    private List<Document>? availableDocuments;
    private HashSet<Guid> newSuiteSelectedDocuments = new();
    private List<Agent>? createSuiteAgents;
    private string? newSuiteSelectedAgentId;
    private bool newSuiteGenerateQuestions = false;
    private int newSuiteQuestionCount = 10;

    private bool showEditModal = false;
    private TestSuite? editingSuite;
    private string editingSuiteName = "";
    private string editingSuiteDescription = "";
    private bool showAddTestCase = false;
    private string newTestCaseName = "";
    private string newTestCaseQuestion = "";
    private string newTestCaseExpectedAnswer = "";
    private string newTestCaseAcceptance = "";
    private bool showEditTestCase = false;
    private TestCase? editingTestCase;
    private string editingTestCaseName = "";
    private string editingTestCaseQuestion = "";
    private string editingTestCaseExpectedAnswer = "";
    private string editingTestCaseAcceptance = "";
    private bool isGeneratingQuestions = false;
    private int aiQuestionCount = 10;
    private bool showImportForm = false;
    private IBrowserFile? selectedImportFile;
    private bool hasFileSelected = false;
    private string importMsg = "";
    private const string CONFIG_FILE = "./data/settings.json";
    private bool showAgentSelectionModal = false;
    private List<Agent>? availableAgents;
    private Guid? selectedAgentId;
    private Guid? pendingSuiteIdForAgent;

    protected override async Task OnInitializedAsync()
    {
        await LoadTestSuites();
    }

    private async Task LoadNewSuiteFormData()
    {
        await LoadDocumentsForNewSuite();
        await LoadAgentsForNewSuite();
    }

    private async Task LoadDocumentsForNewSuite()
    {
        try
        {
            if (DbContext == null) return;
            
            availableDocuments = await DbContext.Documents
                .Include(d => d.Chunks)
                .OrderByDescending(d => d.UploadedAt)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error loading documents: {ex.Message}";
        }
    }

    private async Task LoadAgentsForNewSuite()
    {
        try
        {
            if (DbContext == null) return;
            
            createSuiteAgents = await DbContext.Agents
                .Where(a => a.IsActive)
                .OrderByDescending(a => a.CreatedAt)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error loading agents: {ex.Message}";
        }
    }

    private async Task LoadTestSuites()
    {
        try
        {
            if (DbContext == null) return;
            
            isLoading = true;
            testSuites = await DbContext.TestSuites
                .Include(s => s.TestCases)
                .OrderByDescending(s => s.CreatedAt)
                .ToListAsync();
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMsg = $"Error loading test suites: {ex.Message}";
            isLoading = false;
        }
    }

    private void OnShowNewSuiteForm()
    {
        showNewSuiteForm = true;
        ResetNewSuiteForm();
        _ = LoadNewSuiteFormData();
    }

    private void ResetNewSuiteForm()
    {
        newSuiteName = "";
        newSuiteDescription = "";
        newSuiteSelectedDocuments.Clear();
        newSuiteSelectedAgentId = null;
        newSuiteGenerateQuestions = false;
        newSuiteQuestionCount = 10;
        errorMsg = "";
    }

    private void OnDocumentSelectionChanged(Guid documentId, ChangeEventArgs e)
    {
        var isSelected = e.Value is bool value
            ? value
            : bool.TryParse(e.Value?.ToString(), out var parsed) && parsed;

        if (isSelected)
        {
            newSuiteSelectedDocuments.Add(documentId);
        }
        else
        {
            newSuiteSelectedDocuments.Remove(documentId);
        }
    }

    private void SelectAllNewSuiteDocuments()
    {
        if (availableDocuments != null)
        {
            newSuiteSelectedDocuments.Clear();
            foreach (var doc in availableDocuments)
            {
                newSuiteSelectedDocuments.Add(doc.Id);
            }
        }
    }

    private void ClearNewSuiteDocumentSelection()
    {
        newSuiteSelectedDocuments.Clear();
    }

    private async Task CreateNewSuiteWithOptions()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(newSuiteName))
            {
                errorMsg = "Suite name is required";
                return;
            }

            if (DbContext == null) return;

            var suite = new TestSuite
            {
                Id = Guid.NewGuid(),
                Name = newSuiteName,
                Description = newSuiteDescription ?? "",
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                CreatedBy = "WebUI",
                TestCases = new List<TestCase>()
            };

            DbContext.TestSuites.Add(suite);
            await DbContext.SaveChangesAsync();

            // Link documents if selected
            if (newSuiteSelectedDocuments.Count > 0)
            {
                // Create a placeholder test case to link documents
                var defaultTestCase = new TestCase
                {
                    Id = Guid.NewGuid(),
                    SuiteId = suite.Id,
                    Name = "Default",
                    Description = "Default test case for document linking",
                    UserInput = new string[] { "test" },
                    AcceptanceCriteria = "Test case linked to selected documents",
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                foreach (var documentId in newSuiteSelectedDocuments)
                {
                    defaultTestCase.TestCaseDocuments.Add(new TestCaseDocument
                    {
                        TestCaseId = defaultTestCase.Id,
                        DocumentId = documentId,
                        CreatedAt = DateTime.UtcNow
                    });
                }

                DbContext.TestCases.Add(defaultTestCase);
                await DbContext.SaveChangesAsync();
            }

            successMsg = $"Test suite '{newSuiteName}' created successfully";
            
            // If question generation is enabled, redirect to generate questions
            if (newSuiteGenerateQuestions && newSuiteSelectedDocuments.Count > 0 && !string.IsNullOrEmpty(newSuiteSelectedAgentId))
            {
                // Store the suite ID to edit it with auto-generation
                showNewSuiteForm = false;
                ResetNewSuiteForm();
                await LoadTestSuites();

                // Show success and then auto-open edit modal
                await Task.Delay(500);
                var createdSuite = testSuites?.FirstOrDefault(s => s.Id == suite.Id);
                if (createdSuite != null)
                {
                    await EditSuite(suite.Id);
                }
            }
            else
            {
                showNewSuiteForm = false;
                ResetNewSuiteForm();
                await LoadTestSuites();
            }
        }
        catch (Exception ex)
        {
            errorMsg = $"Error creating test suite: {ex.Message}";
            Console.WriteLine($"Error creating suite: {ex}");
        }
    }

    private async Task CreateNewSuite()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(newSuiteName))
            {
                errorMsg = "Suite name is required";
                return;
            }

            if (DbContext == null) return;

            var suite = new TestSuite
            {
                Id = Guid.NewGuid(),
                Name = newSuiteName,
                Description = newSuiteDescription ?? "",
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow,
                CreatedBy = "WebUI"
            };

            DbContext.TestSuites.Add(suite);
            await DbContext.SaveChangesAsync();

            successMsg = $"Test suite '{newSuiteName}' created successfully";
            newSuiteName = "";
            newSuiteDescription = "";
            showNewSuiteForm = false;

            await LoadTestSuites();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error creating test suite: {ex.Message}";
        }
    }

    private async Task RunSuite(Guid suiteId)
    {
        try
        {
            // Load available agents
            await LoadAvailableAgents();
            
            if (availableAgents == null || availableAgents.Count == 0)
            {
                errorMsg = "No agents available. Please create an agent first in the Agents page.";
                return;
            }

            // Show agent selection modal
            pendingSuiteIdForAgent = suiteId;
            selectedAgentId = availableAgents.FirstOrDefault()?.Id;
            showAgentSelectionModal = true;
        }
        catch (Exception ex)
        {
            errorMsg = $"Error loading agents: {ex.Message}";
        }
    }

    private async Task LoadAvailableAgents()
    {
        try
        {
            if (DbContext == null) return;
            
            availableAgents = await DbContext.Agents
                .Where(a => a.IsActive)
                .OrderBy(a => a.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error loading agents: {ex.Message}";
            availableAgents = new List<Agent>();
        }
    }

    private async Task ConfirmAgentSelection()
    {
        try
        {
            if (!pendingSuiteIdForAgent.HasValue || !selectedAgentId.HasValue)
            {
                errorMsg = "Please select an agent";
                return;
            }

            await ExecuteSuiteWithAgent(pendingSuiteIdForAgent.Value, selectedAgentId.Value);
            showAgentSelectionModal = false;
            pendingSuiteIdForAgent = null;
            selectedAgentId = null;
        }
        catch (Exception ex)
        {
            errorMsg = $"Error running suite: {ex.Message}";
            showAgentSelectionModal = false;
        }
    }

    private async Task ExecuteSuiteWithAgent(Guid suiteId, Guid agentId)
    {
        try
        {
            if (DbContext == null) return;

            var suite = await DbContext.TestSuites
                .Include(s => s.TestCases)
                .FirstOrDefaultAsync(s => s.Id == suiteId);
            if (suite == null) return;

            if (suite.TestCases == null || suite.TestCases.Count == 0)
            {
                errorMsg = "This test suite has no test cases to run.";
                return;
            }

            var agent = await DbContext.Agents.FirstOrDefaultAsync(a => a.Id == agentId);
            if (agent == null)
            {
                errorMsg = "Selected agent not found.";
                return;
            }

            isRunningSuite = true;
            runningSuiteId = suiteId;
            runStatusMsg = $"Running test suite '{suite.Name}' with agent '{agent.Name}'...";
            successMsg = "";
            errorMsg = "";
            await InvokeAsync(StateHasChanged);

            var dlClient = new DirectLineClient(
                agent.DirectLineSecret,
                agent.DirectLineBotId,
                agent.DirectLineReplyTimeoutSeconds,
                agent.DirectLineUseWebChannelSecret);

            var judgeSettings = new JudgeSetting
            {
                Endpoint = agent.JudgeEndpoint,
                ApiKey = agent.JudgeApiKey,
                Model = agent.JudgeModel,
                Temperature = agent.JudgeTemperature,
                TopP = agent.JudgeTopP,
                MaxOutputTokens = agent.JudgeMaxOutputTokens,
                PassThreshold = agent.JudgePassThreshold
            };

            var dlSettings = new DirectLineSettings
            {
                Secret = agent.DirectLineSecret,
                BotId = agent.DirectLineBotId,
                UseWebChannelSecret = agent.DirectLineUseWebChannelSecret,
                UseWebSocket = agent.DirectLineUseWebSocket,
                ReplyTimeoutSeconds = agent.DirectLineReplyTimeoutSeconds,
                MaxRetries = agent.DirectLineMaxRetries,
                BackoffSeconds = agent.DirectLineBackoffSeconds
            };

            var run = await ExecutionService.ExecuteTestSuiteAsync(
                suiteId,
                DbContext,
                dlClient,
                JudgeService,
                judgeSettings,
                dlSettings,
                2000,
                agentId);

            successMsg = $"Test suite '{suite.Name}' completed with '{agent.Name}': {run.PassedCount} passed, {run.FailedCount} failed.";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error running test suite: {ex.Message}";
        }
        finally
        {
            isRunningSuite = false;
            runningSuiteId = null;
            runStatusMsg = "";
        }
    }

    private async Task DeleteSuite(Guid suiteId)
    {
        try
        {
            if (DbContext == null) return;

            var suite = await DbContext.TestSuites.FindAsync(suiteId);
            if (suite == null) return;

            DbContext.TestSuites.Remove(suite);
            await DbContext.SaveChangesAsync();

            successMsg = $"Test suite deleted";
            await LoadTestSuites();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error deleting test suite: {ex.Message}";
        }
    }

    private async Task Refresh()
    {
        await LoadTestSuites();
    }

    private async Task EditSuite(Guid suiteId)
    {
        try
        {
            if (DbContext == null) return;

            editingSuite = await DbContext.TestSuites
                .Include(s => s.TestCases)
                .FirstOrDefaultAsync(s => s.Id == suiteId);

            if (editingSuite != null)
            {
                editingSuiteName = editingSuite.Name;
                editingSuiteDescription = editingSuite.Description ?? "";
                showEditModal = true;
                showAddTestCase = false;
            }
        }
        catch (Exception ex)
        {
            errorMsg = $"Error loading test suite: {ex.Message}";
        }
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editingSuite = null;
        showAddTestCase = false;
    }

    private async Task SaveSuiteChanges()
    {
        try
        {
            if (DbContext == null || editingSuite == null) return;

            editingSuite.Name = editingSuiteName;
            editingSuite.Description = editingSuiteDescription;
            editingSuite.UpdatedAt = DateTime.UtcNow;

            await DbContext.SaveChangesAsync();
            successMsg = "Test suite updated successfully";
            showEditModal = false;
            await LoadTestSuites();
        }
        catch (Exception ex)
        {
            errorMsg = $"Error saving changes: {ex.Message}";
        }
    }

    private void ShowAddTestCaseForm()
    {
        showAddTestCase = true;
        newTestCaseName = "";
        newTestCaseQuestion = "";
        newTestCaseExpectedAnswer = "";
        newTestCaseAcceptance = "";
    }

    private async Task GenerateAdditionalQuestionsForTestCase(Guid testCaseId)
    {
        try
        {
            if (DbContext == null || editingSuite == null) return;

            var sourceTestCase = editingSuite.TestCases?.FirstOrDefault(tc => tc.Id == testCaseId);
            if (sourceTestCase == null) return;

            isGeneratingQuestions = true;
            errorMsg = "";

            var settings = await LoadQuestionGenSettings();
            if (string.IsNullOrWhiteSpace(settings.Endpoint) || string.IsNullOrWhiteSpace(settings.ApiKey))
            {
                errorMsg = "Missing Azure OpenAI settings. Configure Judge settings in the Setup Wizard first.";
                return;
            }

            var existingQuestion = sourceTestCase.UserInput?.FirstOrDefault() ?? sourceTestCase.Description ?? "";
            if (string.IsNullOrWhiteSpace(existingQuestion))
            {
                errorMsg = "Test case has no question to generate variations from.";
                return;
            }

            var documentContent = await BuildDocumentContent();
            if (string.IsNullOrWhiteSpace(documentContent))
            {
                errorMsg = "No document content found. Upload documents for context before generating variations.";
                return;
            }

            var allExistingQuestions = editingSuite.TestCases
                .Select(tc => tc.UserInput?.FirstOrDefault() ?? tc.Description)
                .Where(q => !string.IsNullOrWhiteSpace(q))
                .ToList();

            var userPrompt = "Generate 10 semantically different variations of this question. Use different wording, phrasing, and structure but ask for the same information:\n\n" +
                "ORIGINAL: \"" + existingQuestion + "\"\n\n" +
                "Return ONLY valid JSON array.";

            var request = new QuestionGenerationRequest
            {
                DocumentContent = documentContent,
                NumberOfQuestions = 10,
                Domain = editingSuite.Name,
                ExistingQuestions = allExistingQuestions
            };

            var aiQuestions = await QuestionGenerationService.GenerateQuestionsAsync(
                request,
                settings.Endpoint,
                settings.ApiKey,
                settings.Model);

            if (aiQuestions == null || aiQuestions.Count == 0)
            {
                errorMsg = "No variations could be generated.";
                return;
            }

            editingSuite.TestCases ??= new List<TestCase>();
            var startingIndex = editingSuite.TestCases.Count + 1;
            var generatedCount = 0;

            foreach (var q in aiQuestions.Take(10))
            {
                try
                {
                    if (string.IsNullOrWhiteSpace(q.Question)) continue;

                    var testCase = new TestCase
                    {
                        Id = Guid.NewGuid(),
                        SuiteId = editingSuite.Id,
                        Name = "Variation " + startingIndex.ToString(),
                        Description = q.Question,
                        UserInput = new[] { q.Question },
                        ExpectedIntent = sourceTestCase.ExpectedIntent,
                        ExpectedEntities = sourceTestCase.ExpectedEntities,
                        AcceptanceCriteria = sourceTestCase.AcceptanceCriteria,
                        ReferenceAnswer = sourceTestCase.ReferenceAnswer,
                        Category = "variation",
                        Priority = sourceTestCase.Priority,
                        IsGenerated = true,
                        TimeoutSeconds = sourceTestCase.TimeoutSeconds,
                        MaxRetries = sourceTestCase.MaxRetries,
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow,
                        SourceDocumentId = sourceTestCase.SourceDocumentId
                    };

                    editingSuite.TestCases.Add(testCase);
                    DbContext.TestCases.Add(testCase);
                    generatedCount++;
                    startingIndex++;
                }
                catch
                {
                    continue;
                }
            }

            if (generatedCount > 0)
            {
                editingSuite.UpdatedAt = DateTime.UtcNow;
                await DbContext.SaveChangesAsync();
                successMsg = "Generated " + generatedCount.ToString() + " semantic variations";
            }
            else
            {
                errorMsg = "Could not generate valid question variations.";
            }
        }
        catch (Exception ex)
        {
            errorMsg = "Error generating variations: " + ex.Message;
        }
        finally
        {
            isGeneratingQuestions = false;
        }
    }

    private async Task GenerateAiQuestions(bool replaceExisting)
    {
        try
        {
            if (DbContext == null || editingSuite == null) return;

            isGeneratingQuestions = true;
            errorMsg = "";

            var settings = await LoadQuestionGenSettings();
            if (string.IsNullOrWhiteSpace(settings.Endpoint) || string.IsNullOrWhiteSpace(settings.ApiKey))
            {
                errorMsg = "Missing Azure OpenAI settings. Configure Judge settings in the Setup Wizard first.";
                return;
            }

            var documentContent = await BuildDocumentContent();
            if (string.IsNullOrWhiteSpace(documentContent))
            {
                errorMsg = "No document content found. Upload documents before generating AI questions.";
                return;
            }

            var existingQuestions = (editingSuite.TestCases ?? Array.Empty<TestCase>())
                .Select(tc => tc.UserInput?.FirstOrDefault() ?? tc.Description)
                .Where(q => !string.IsNullOrWhiteSpace(q))
                .ToList();

            var request = new QuestionGenerationRequest
            {
                DocumentContent = documentContent,
                NumberOfQuestions = Math.Max(1, aiQuestionCount),
                Domain = editingSuite.Name,
                ExistingQuestions = replaceExisting ? null : existingQuestions
            };

            var aiQuestions = await QuestionGenerationService.GenerateQuestionsAsync(
                request,
                settings.Endpoint,
                settings.ApiKey,
                settings.Model);

            if (aiQuestions.Count == 0)
            {
                errorMsg = "AI question generation returned no results.";
                return;
            }

            if (replaceExisting)
            {
                var existing = DbContext.TestCases.Where(tc => tc.SuiteId == editingSuite.Id);
                DbContext.TestCases.RemoveRange(existing);
                editingSuite.TestCases?.Clear();
            }

            editingSuite.TestCases ??= new List<TestCase>();
            var startingIndex = editingSuite.TestCases.Count + 1;

            foreach (var q in aiQuestions)
            {
                var testCase = new TestCase
                {
                    Id = Guid.NewGuid(),
                    SuiteId = editingSuite.Id,
                    Name = $"AI Test {startingIndex++}",
                    Description = q.Question,
                    UserInput = new[] { q.Question },
                    ExpectedIntent = string.IsNullOrWhiteSpace(q.ExpectedIntent) ? null : q.ExpectedIntent,
                    ExpectedEntities = q.ExpectedEntities?.ToArray() ?? [],
                    AcceptanceCriteria = string.IsNullOrWhiteSpace(q.Rationale)
                        ? "Response should be relevant and accurate"
                        : q.Rationale,
                    ReferenceAnswer = string.IsNullOrWhiteSpace(q.ExpectedAnswer) ? null : q.ExpectedAnswer,
                    Category = "ai-generated",
                    Priority = 1,
                    IsGenerated = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                editingSuite.TestCases.Add(testCase);
                DbContext.TestCases.Add(testCase);
            }

            editingSuite.UpdatedAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();

            successMsg = replaceExisting
                ? $"Replaced test cases with {aiQuestions.Count} AI-generated questions"
                : $"Added {aiQuestions.Count} AI-generated questions";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error generating AI questions: {ex.Message}";
        }
        finally
        {
            isGeneratingQuestions = false;
        }
    }

    private async Task<string> BuildDocumentContent()
    {
        if (DbContext == null) return string.Empty;

        var documents = await DbContext.Documents
            .Include(d => d.Chunks)
            .OrderByDescending(d => d.UploadedAt)
            .ToListAsync();

        var chunks = documents
            .SelectMany(d => d.Chunks)
            .Select(c => c.Text)
            .Where(t => !string.IsNullOrWhiteSpace(t))
            .ToList();

        if (chunks.Count == 0)
        {
            return string.Empty;
        }

        var content = string.Join("\n\n---\n\n", chunks);
        if (content.Length > 12000)
        {
            content = content.Substring(0, 12000) + "\n\n[Content truncated for length...]";
        }

        return content;
    }

    private async Task<(string Endpoint, string ApiKey, string Model)> LoadQuestionGenSettings()
    {
        try
        {
            if (!File.Exists(CONFIG_FILE))
            {
                return (string.Empty, string.Empty, string.Empty);
            }

            var json = await File.ReadAllTextAsync(CONFIG_FILE);
            var config = JsonSerializer.Deserialize<ConfigData>(json);

            if (config?.Judge == null)
            {
                return (string.Empty, string.Empty, string.Empty);
            }

            return (
                config.Judge.Endpoint,
                config.Judge.Key,
                string.IsNullOrWhiteSpace(config.Judge.Model) ? "gpt-4o-mini" : config.Judge.Model
            );
        }
        catch
        {
            return (string.Empty, string.Empty, string.Empty);
        }
    }

    private async Task<ConfigData?> LoadRunSettings()
    {
        try
        {
            if (!File.Exists(CONFIG_FILE))
            {
                return null;
            }

            var json = await File.ReadAllTextAsync(CONFIG_FILE);
            return JsonSerializer.Deserialize<ConfigData>(json);
        }
        catch
        {
            return null;
        }
    }

    private async Task AddTestCase()
    {
        try
        {
            if (DbContext == null || editingSuite == null) return;
            if (string.IsNullOrWhiteSpace(newTestCaseQuestion)) return;

            var testCase = new TestCase
            {
                Id = Guid.NewGuid(),
                SuiteId = editingSuite.Id,
                Name = string.IsNullOrWhiteSpace(newTestCaseName) ? $"Test {editingSuite.TestCases.Count + 1}" : newTestCaseName,
                Description = newTestCaseQuestion,
                UserInput = new string[] { newTestCaseQuestion },
                ReferenceAnswer = newTestCaseExpectedAnswer,
                AcceptanceCriteria = string.IsNullOrWhiteSpace(newTestCaseAcceptance) 
                    ? "Response should be relevant and accurate" 
                    : newTestCaseAcceptance,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };

            editingSuite.TestCases ??= new List<TestCase>();
            editingSuite.TestCases.Add(testCase);
            DbContext.TestCases.Add(testCase);
            await DbContext.SaveChangesAsync();

            successMsg = "Test case added successfully";
            showAddTestCase = false;
            newTestCaseName = "";
            newTestCaseQuestion = "";
            newTestCaseExpectedAnswer = "";
            newTestCaseAcceptance = "";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error adding test case: {ex.Message}";
        }
    }

    private async Task DeleteTestCase(Guid testCaseId)
    {
        try
        {
            if (DbContext == null || editingSuite == null) return;

            var testCase = await DbContext.TestCases.FindAsync(testCaseId);
            if (testCase == null) return;

            DbContext.TestCases.Remove(testCase);
            await DbContext.SaveChangesAsync();

            var tcToRemove = editingSuite.TestCases?.FirstOrDefault(tc => tc.Id == testCaseId);
            if (tcToRemove != null)
            {
                editingSuite.TestCases?.Remove(tcToRemove);
            }
            successMsg = "Test case deleted";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error deleting test case: {ex.Message}";
        }
    }

    private void EditTestCase(Guid testCaseId)
    {
        if (editingSuite?.TestCases == null) return;

        editingTestCase = editingSuite.TestCases.FirstOrDefault(tc => tc.Id == testCaseId);
        if (editingTestCase == null) return;

        editingTestCaseName = editingTestCase.Name;
        editingTestCaseQuestion = editingTestCase.UserInput?.FirstOrDefault() ?? editingTestCase.Description ?? "";
        editingTestCaseExpectedAnswer = editingTestCase.ReferenceAnswer ?? "";
        editingTestCaseAcceptance = editingTestCase.AcceptanceCriteria ?? "";
        showEditTestCase = true;
    }

    private async Task SaveTestCaseChanges()
    {
        try
        {
            if (DbContext == null || editingSuite == null || editingTestCase == null) return;
            if (string.IsNullOrWhiteSpace(editingTestCaseQuestion)) return;

            editingTestCase.Name = editingTestCaseName;
            editingTestCase.Description = editingTestCaseQuestion;
            editingTestCase.UserInput = new[] { editingTestCaseQuestion };
            editingTestCase.ReferenceAnswer = string.IsNullOrWhiteSpace(editingTestCaseExpectedAnswer) 
                ? null 
                : editingTestCaseExpectedAnswer;
            editingTestCase.AcceptanceCriteria = string.IsNullOrWhiteSpace(editingTestCaseAcceptance) 
                ? "Response should be relevant and accurate" 
                : editingTestCaseAcceptance;
            editingTestCase.UpdatedAt = DateTime.UtcNow;

            await DbContext.SaveChangesAsync();
            successMsg = "Test case updated successfully";
            showEditTestCase = false;
            editingTestCase = null;
        }
        catch (Exception ex)
        {
            errorMsg = $"Error saving test case: {ex.Message}";
        }
    }

    private void ShowImportForm()
    {
        showImportForm = true;
        importMsg = "";
        hasFileSelected = false;
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedImportFile = e.File;
        hasFileSelected = e.File != null;
        importMsg = hasFileSelected ? $"Selected: {e.File.Name}" : "";
    }

    private async Task DownloadTemplateCSV()
    {
        try
        {
            var templatePath = "assets/EvaluationTemplate.csv";
            if (!File.Exists(templatePath))
            {
                errorMsg = "Template file not found";
                return;
            }

            var content = await File.ReadAllTextAsync(templatePath);
            var bytes = System.Text.Encoding.UTF8.GetBytes(content);
            
            // Trigger browser download
            await JS.InvokeVoidAsync("downloadFile", bytes, "evaluation-template.csv", "text/csv");
            successMsg = "Template downloaded successfully";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error downloading template: {ex.Message}";
        }
    }

    private async Task ExportTestCasesCSV()
    {
        try
        {
            if (editingSuite == null || editingSuite.TestCases == null || editingSuite.TestCases.Count == 0)
            {
                errorMsg = "No test cases to export";
                return;
            }

            var csv = new System.Text.StringBuilder();
            csv.AppendLine("\"question\",\"expectedResponse\"");

            foreach (var testCase in editingSuite.TestCases)
            {
                var question = testCase.UserInput?.FirstOrDefault() ?? testCase.Description ?? "";
                var expectedResponse = testCase.ReferenceAnswer ?? testCase.AcceptanceCriteria ?? "";
                
                // Escape quotes in CSV
                question = question.Replace("\"", "\"\"");
                expectedResponse = expectedResponse.Replace("\"", "\"\"");
                
                csv.AppendLine($"\"{question}\",\"{expectedResponse}\"");
            }

            var content = csv.ToString();
            var bytes = System.Text.Encoding.UTF8.GetBytes(content);
            var fileName = $"{editingSuite.Name.Replace(" ", "-")}-test-cases.csv";
            
            // Trigger browser download
            await JS.InvokeVoidAsync("downloadFile", bytes, fileName, "text/csv");
            successMsg = $"Exported {editingSuite.TestCases.Count} test cases";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error exporting test cases: {ex.Message}";
        }
    }

    private async Task ImportTestCasesFromCSV()
    {
        try
        {
            if (selectedImportFile == null || !hasFileSelected)
            {
                importMsg = "Please select a CSV file";
                return;
            }

            var file = selectedImportFile;
            if (DbContext == null || editingSuite == null) return;

            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024); // 1MB max
            using var reader = new System.IO.StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            var lines = content.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.None);
            
            if (lines.Length < 2)
            {
                importMsg = "CSV file must have at least a header row";
                return;
            }

            // Parse header
            var headerLine = lines[0];
            var headers = ParseCsvLine(headerLine);
            
            var questionIndex = headers.FindIndex(h => h.Equals("question", StringComparison.OrdinalIgnoreCase));
            var responseIndex = headers.FindIndex(h => h.Equals("expectedResponse", StringComparison.OrdinalIgnoreCase));

            if (questionIndex == -1)
            {
                importMsg = "CSV must have a 'question' column";
                return;
            }

            var importedCount = 0;
            var startingIndex = (editingSuite.TestCases?.Count ?? 0) + 1;

            for (int i = 1; i < lines.Length; i++)
            {
                if (string.IsNullOrWhiteSpace(lines[i])) continue;

                var values = ParseCsvLine(lines[i]);
                if (values.Count == 0 || string.IsNullOrWhiteSpace(values[questionIndex])) continue;

                var question = values[questionIndex];
                var expectedResponse = responseIndex >= 0 && responseIndex < values.Count 
                    ? values[responseIndex] 
                    : "";

                if (question.Length > 500)
                {
                    question = question.Substring(0, 500);
                }

                var testCase = new TestCase
                {
                    Id = Guid.NewGuid(),
                    SuiteId = editingSuite.Id,
                    Name = $"Imported Test {startingIndex++}",
                    Description = question,
                    UserInput = new[] { question },
                    ReferenceAnswer = string.IsNullOrWhiteSpace(expectedResponse) ? null : expectedResponse,
                    AcceptanceCriteria = string.IsNullOrWhiteSpace(expectedResponse) 
                        ? "Response should be relevant and accurate"
                        : expectedResponse,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                editingSuite.TestCases ??= new List<TestCase>();
                editingSuite.TestCases.Add(testCase);
                DbContext.TestCases.Add(testCase);
                importedCount++;

                if (importedCount >= 100)
                {
                    importMsg = "Maximum 100 questions allowed per import";
                    break;
                }
            }

            if (importedCount == 0)
            {
                importMsg = "No valid test cases found in CSV";
                return;
            }

            editingSuite.UpdatedAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();

            successMsg = $"Successfully imported {importedCount} test cases";
            showImportForm = false;
            selectedImportFile = null;
            hasFileSelected = false;
            importMsg = "";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error importing test cases: {ex.Message}";
        }
    }

    private List<string> ParseCsvLine(string line)
    {
        var values = new List<string>();
        var currentValue = new System.Text.StringBuilder();
        var inQuotes = false;

        for (int i = 0; i < line.Length; i++)
        {
            var c = line[i];

            if (c == '"')
            {
                if (inQuotes && i + 1 < line.Length && line[i + 1] == '"')
                {
                    currentValue.Append('"');
                    i++;
                }
                else
                {
                    inQuotes = !inQuotes;
                }
            }
            else if (c == ',' && !inQuotes)
            {
                values.Add(currentValue.ToString());
                currentValue.Clear();
            }
            else
            {
                currentValue.Append(c);
            }
        }

        values.Add(currentValue.ToString());
        return values;
    }

    private class ConfigData
    {
        public DirectLineConfig? DirectLine { get; set; }
        public JudgeConfig? Judge { get; set; }
    }

    private class DirectLineConfig
    {
        public string BotId { get; set; } = "";
        public string Secret { get; set; } = "";
        public bool UseWebChannelSecret { get; set; } = false;
        public int Timeout { get; set; } = 30;
        public bool UseWebSocket { get; set; } = true;
    }

    private class JudgeConfig
    {
        public string Endpoint { get; set; } = "";
        public string Key { get; set; } = "";
        public string Model { get; set; } = "gpt-4o";
        public double Temperature { get; set; } = 0.2;
        public double TopP { get; set; } = 0.9;
        public double PassThreshold { get; set; } = 0.7;
    }
}
